
## âœ… **ç¬¬ä¸€æ­¥ï¼šé—®é¢˜å»ºæ¨¡ä¸ºçº¦æŸä¼˜åŒ–**

Safe RLHF çš„æ ¸å¿ƒç›®æ ‡æ˜¯åœ¨**æ»¡è¶³å®‰å…¨æ€§çº¦æŸçš„å‰æä¸‹æœ€å¤§åŒ–æœ‰ç”¨æ€§**ã€‚è¿™è¢«å½¢å¼åŒ–ä¸ºä¸€ä¸ªå¸¦çº¦æŸçš„ä¼˜åŒ–é—®é¢˜ï¼š

\[
\begin{aligned}
\max_{\theta} \quad & \mathcal{J}_R(\theta) \quad &\text{(æœ€å¤§åŒ–å¥–åŠ±: æœ‰ç”¨æ€§)} \\
\text{s.t.} \quad & \mathcal{J}_C(\theta) \leq 0 \quad &\text{(çº¦æŸ: æˆæœ¬ â‰¤ 0, å³æ— å®³)}
\end{aligned}
\]

å…¶ä¸­ï¼š
- \(\mathcal{J}_R(\theta) = \mathbb{E}_{x \sim \mathcal{D}, y \sim \pi_\theta(\cdot|x)}[R_\phi(y, x)]\)  
- \(\mathcal{J}_C(\theta) = \mathbb{E}_{x \sim \mathcal{D}, y \sim \pi_\theta(\cdot|x)}[C_\psi(y, x)] + d\)  
  \(d\) æ˜¯ä¸€ä¸ªå¯è°ƒé˜ˆå€¼ï¼Œç”¨äºŽæŽ§åˆ¶çº¦æŸçš„æ¾ç´§åº¦ï¼ˆä¾‹å¦‚ \(d = -3\) è¡¨ç¤ºæˆæœ¬æœŸæœ›éœ€ä½ŽäºŽ -3ï¼‰ã€‚

---

## âœ… **ç¬¬äºŒæ­¥ï¼šæž„å»ºæ‹‰æ ¼æœ—æ—¥å‡½æ•°**

å¯¹äºŽå¸¦çº¦æŸçš„ä¼˜åŒ–é—®é¢˜ï¼Œæˆ‘ä»¬å¼•å…¥**æ‹‰æ ¼æœ—æ—¥ä¹˜å­ Î» (Î» â‰¥ 0)**ï¼Œæž„é€ æ‹‰æ ¼æœ—æ—¥å‡½æ•° \(L(\theta, \lambda)\)ï¼š

\[
L(\theta, \lambda) = \mathcal{J}_R(\theta) - \lambda \cdot \mathcal{J}_C(\theta)
\]

æ³¨æ„è¿™é‡Œç”¨çš„æ˜¯ **â€œâˆ’â€å·**ï¼Œå› ä¸ºåŽŸå§‹é—®é¢˜æ˜¯æœ€å¤§åŒ– \(\mathcal{J}_R\) ä¸”çº¦æŸä¸º \(\mathcal{J}_C \leq 0\)ã€‚æ‹‰æ ¼æœ—æ—¥æ–¹æ³•æ˜¯å°†çº¦æŸæ¡ä»¶è½¬åŒ–ä¸ºæƒ©ç½šé¡¹ã€‚

å¯¹åº”çš„**æ‹‰æ ¼æœ—æ—¥å¯¹å¶é—®é¢˜**æ˜¯ï¼š

\[
\min_{\lambda \geq 0} \max_{\theta} \; L(\theta, \lambda) 
\quad \text{æˆ–ç­‰ä»·åœ°} \quad 
\min_{\lambda \geq 0} \max_{\theta} \; [\mathcal{J}_R(\theta) - \lambda \cdot \mathcal{J}_C(\theta)]
\]

---

## âœ… **ç¬¬ä¸‰æ­¥ï¼šäº¤æ›¿ä¼˜åŒ–ï¼ˆPrimal-Dual Updateï¼‰**

æ±‚è§£è¿™ä¸ª min-max é—®é¢˜é‡‡ç”¨**äº¤æ›¿æ›´æ–°**çš„ç­–ç•¥ï¼š
1. **å†…å±‚ï¼ˆPrimalï¼‰ï¼šå›ºå®š Î»ï¼Œæ›´æ–° Î¸** ä»¥æœ€å¤§åŒ– \(L(\theta, \lambda)\);
2. **å¤–å±‚ï¼ˆDualï¼‰ï¼šå›ºå®š Î¸ï¼Œæ›´æ–° Î»** ä»¥æœ€å°åŒ– \(L(\theta, \lambda)\)ã€‚

### âœ… **3.1 å†…å±‚ï¼šæ›´æ–°æ¨¡åž‹å‚æ•° Î¸**
å›ºå®š Î»ï¼Œå¯¹ Î¸ è¿›è¡Œæ¢¯åº¦**ä¸Šå‡**ï¼ˆå› ä¸ºè¦æœ€å¤§åŒ–ï¼‰ï¼š

\[
\theta_{k+1} = \theta_k + \eta_\theta \cdot \nabla_\theta \left[ \mathcal{J}_R(\theta_k) - \lambda_k \cdot \mathcal{J}_C(\theta_k) \right]
\]

åœ¨å®žé™…çš„ RL è®­ç»ƒä¸­ï¼Œ\(\nabla_\theta \mathcal{J}_R\) å’Œ \(\nabla_\theta \mathcal{J}_C\) æ˜¯é€šè¿‡ **PPO ç­–ç•¥æ¢¯åº¦** è®¡ç®—çš„ï¼ˆå‚è§è®ºæ–‡é™„å½• B.3 ä¸­çš„å…¬å¼ 27-29ï¼‰ã€‚

---

### âœ… **3.2 å¤–å±‚ï¼šæ›´æ–°æ‹‰æ ¼æœ—æ—¥ä¹˜å­ Î»**
å›ºå®š Î¸ï¼Œå¯¹ Î» è¿›è¡Œæ¢¯åº¦**ä¸‹é™**ï¼ˆå› ä¸ºè¦æœ€å°åŒ– \(L\) å¯¹ Î»ï¼‰ï¼ŒåŒæ—¶ç¡®ä¿ Î» â‰¥ 0ã€‚

#### **æ¢¯åº¦è®¡ç®—ï¼š**
\[
\frac{\partial L(\theta, \lambda)}{\partial \lambda} = -\mathcal{J}_C(\theta)
\]

å› æ­¤ï¼Œæ ‡å‡†çš„æ¢¯åº¦ä¸‹é™æ›´æ–°ä¸ºï¼š
\[
\lambda_{k+1} = \lambda_k - \alpha \cdot (-\mathcal{J}_C(\theta_k)) = \lambda_k + \alpha \cdot \mathcal{J}_C(\theta_k)
\]

---

## âœ… **ç¬¬å››æ­¥ï¼šç¡®ä¿ Î» â‰¥ 0 çš„æŠ€å·§**

ç”±äºŽ Î» å¿…é¡»éžè´Ÿï¼Œç›´æŽ¥ä½¿ç”¨ä¸Šè¿°æ›´æ–°å¯èƒ½å¯¼è‡´ Î» å˜ä¸ºè´Ÿæ•°ã€‚è®ºæ–‡é‡‡ç”¨äº†ä¸€ä¸ª**ä¼˜é›…çš„æŠ€å·§ï¼šåœ¨ log ç©ºé—´è¿›è¡Œæ›´æ–°**ã€‚

ä»¤ \(\lambda = \exp(\ln \lambda)\)ï¼Œåœ¨ **log ç©ºé—´** è¿›è¡Œæ¢¯åº¦æ›´æ–°ï¼š

\[
\ln \lambda_{k+1} = \ln \lambda_k + \alpha \cdot \frac{\partial L}{\partial \ln \lambda}
\]

å…¶ä¸­ï¼š
\[
\frac{\partial L}{\partial \ln \lambda} = \frac{\partial L}{\partial \lambda} \cdot \frac{\partial \lambda}{\partial \ln \lambda} = (-\mathcal{J}_C) \cdot \lambda
\]

å› æ­¤ï¼š
\[
\ln \lambda_{k+1} = \ln \lambda_k + \alpha \cdot (-\mathcal{J}_C) \cdot \lambda_k
\]

ä½†æ³¨æ„ï¼Œè®ºæ–‡ä¸­ä½¿ç”¨çš„å®žé™…å…¬å¼æ˜¯ï¼š
\[
\ln \lambda_{k+1} = \ln \lambda_k + \alpha \cdot \lambda_k \cdot \mathcal{J}_C(\theta_k)
\]

**æ³¨æ„ç¬¦å·**ï¼šè¿™é‡Œä¼¼ä¹Žæ˜¯ **+Î±Â·Î»Â·ð’¥_C** è€Œéž **-Î±Â·Î»Â·ð’¥_C**ã€‚è¿™å–å†³äºŽ**æ‹‰æ ¼æœ—æ—¥å‡½æ•°çš„å®šä¹‰ç¬¦å·**å’Œ**å¯¹å¶é—®é¢˜çš„å½¢å¼**ã€‚åœ¨è®ºæ–‡çš„å…¬å¼ (12) ä¸­ï¼Œä»–ä»¬å†™çš„æ˜¯ï¼š

\[
\min_{\theta} \max_{\lambda \geq 0} \left[ -\mathcal{J}_R(\theta) + \lambda \cdot \mathcal{J}_C(\theta) \right]
\]

è‹¥ä»¥æ­¤å½¢å¼ï¼Œåˆ™ï¼š
\[
\frac{\partial}{\partial \lambda} [-\mathcal{J}_R + \lambda \mathcal{J}_C] = \mathcal{J}_C
\]
å› æ­¤æ›´æ–°ä¸ºï¼š
\[
\ln \lambda_{k+1} = \ln \lambda_k + \alpha \cdot \lambda_k \cdot \mathcal{J}_C
\]

---

## âœ… **ç¬¬äº”æ­¥ï¼šæŒ‡æ•°å˜æ¢å›ž Î» ç©ºé—´**

ä»Ž log ç©ºé—´å˜æ¢å›žåŽŸå§‹ Î» ç©ºé—´ï¼š
\[
\lambda_{k+1} = \exp(\ln \lambda_{k+1}) = \lambda_k \cdot \exp\left( \alpha \cdot \lambda_k \cdot \mathcal{J}_C(\theta_k) \right)
\]

---

## âœ… **ç¬¬å…­æ­¥ï¼šç‰©ç†å«ä¹‰ä¸Žè¡Œä¸ºåˆ†æž**

è¿™ä¸ªæ›´æ–°è§„åˆ™éžå¸¸ç›´è§‚ï¼š

- **è‹¥ \(\mathcal{J}_C > 0\)ï¼ˆæˆæœ¬ä¸ºæ­£ï¼Œæœ‰å®³ï¼‰**ï¼š  
  \(\exp(\alpha \lambda \mathcal{J}_C) > 1\) â†’ Î» å¢žå¤§ â†’ åŠ å¼ºæ— å®³æ€§æƒ©ç½šã€‚

- **è‹¥ \(\mathcal{J}_C < 0\)ï¼ˆæˆæœ¬ä¸ºè´Ÿï¼Œå®‰å…¨ï¼‰**ï¼š  
  \(\exp(\alpha \lambda \mathcal{J}_C) < 1\) â†’ Î» å‡å° â†’ å‡å¼±æƒ©ç½šï¼Œä¸“æ³¨æœ‰ç”¨æ€§ã€‚

- **è‹¥ \(\mathcal{J}_C = 0\)ï¼ˆåˆšå¥½æ»¡è¶³çº¦æŸï¼‰**ï¼š  
  Î» ä¿æŒä¸å˜ã€‚

---

## âœ… **ç¬¬ä¸ƒæ­¥ï¼šå®žé™…è®­ç»ƒä¸­çš„å®žçŽ°ç»†èŠ‚**

åœ¨å®žé™…è®­ç»ƒä¸­ï¼ˆå¦‚é™„å½• B.3 æ‰€è¿°ï¼‰ï¼š

1. **ð’¥_C çš„ä¼°è®¡**ï¼šä½¿ç”¨**æ»‘åŠ¨å¹³å‡**æ¥è®¡ç®— \(\mathcal{J}_C(\theta_k)\)ï¼Œé¿å…å•æ‰¹æ•°æ®çš„å™ªå£°æ³¢åŠ¨ã€‚
2. **å­¦ä¹ çŽ‡ Î±**ï¼šé€šå¸¸å¾ˆå°ï¼ˆå¦‚ 0.01 æˆ– 0.04ï¼‰ï¼Œç¡®ä¿ Î» å¹³æ»‘å˜åŒ–ã€‚
3. **åˆå§‹åŒ– Î»â‚€**ï¼šè®¾ä¸º 0.5 æˆ– 1ã€‚
4. **é˜ˆå€¼ d**ï¼šåœ¨ ð’¥_C çš„å®šä¹‰ä¸­å·²åŒ…å«ï¼Œç”¨äºŽè®¾å®šâ€œå¤šå®‰å…¨æ‰ç®—å®‰å…¨â€çš„æ ‡å‡†ã€‚

---

## âœ… **æ•°å­¦æŽ¨å¯¼æ€»ç»“è¡¨**

| æ­¥éª¤ | å…¬å¼ | è¯´æ˜Ž |
|------|------|------|
| **åŽŸå§‹é—®é¢˜** | \(\max \mathcal{J}_R \text{ s.t. } \mathcal{J}_C \leq 0\) | å¸¦çº¦æŸä¼˜åŒ– |
| **æ‹‰æ ¼æœ—æ—¥å‡½æ•°** | \(L(\theta, \lambda) = -\mathcal{J}_R + \lambda \mathcal{J}_C\) | å¯¹å¶å½¢å¼ï¼ˆè®ºæ–‡ Eq.12ï¼‰ |
| **å¯¹ Î» æ¢¯åº¦** | \(\frac{\partial L}{\partial \lambda} = \mathcal{J}_C\) |  |
| **Log ç©ºé—´æ¢¯åº¦** | \(\frac{\partial L}{\partial \ln \lambda} = \lambda \cdot \mathcal{J}_C\) | é“¾å¼æ³•åˆ™ |
| **Log æ›´æ–°** | \(\ln \lambda' = \ln \lambda + \alpha \cdot \lambda \cdot \mathcal{J}_C\) | æ¢¯åº¦ä¸Šå‡ |
| **æŒ‡æ•°å˜æ¢** | \(\lambda' = \lambda \cdot \exp(\alpha \cdot \lambda \cdot \mathcal{J}_C)\) | æœ€ç»ˆæ›´æ–°å…¬å¼ |

---

## âœ… **ç›´è§‚ç†è§£ï¼šÎ» æ˜¯â€œå®‰å…¨ç›‘ç®¡å‘˜â€**

ä½ å¯ä»¥å°† Î» çœ‹ä½œä¸€ä¸ª**åŠ¨æ€çš„å®‰å…¨ç›‘ç®¡å‘˜**ï¼š
- **æ¨¡åž‹æœ‰å®³æ—¶**ï¼šç›‘ç®¡å‘˜åŠ å¤§æƒ©ç½šåŠ›åº¦ï¼ˆÎ»â†‘ï¼‰
- **æ¨¡åž‹å®‰å…¨æ—¶**ï¼šç›‘ç®¡å‘˜æ”¾æ¾ç®¡åˆ¶ï¼ˆÎ»â†“ï¼‰
- **å§‹ç»ˆéžè´Ÿ**ï¼šæƒ©ç½šåŠ›åº¦ä¸ä¼šä¸ºè´Ÿï¼ˆÎ» â‰¥ 0ï¼‰

è¿™ç§æœºåˆ¶ç¡®ä¿äº†æ¨¡åž‹åœ¨**æ»¡è¶³å®‰å…¨åº•çº¿çš„å‰æä¸‹**ï¼Œå°½å¯èƒ½æå‡æœ‰ç”¨æ€§ï¼Œå®žçŽ°äº†**åŠ¨æ€å¹³è¡¡**ï¼Œé¿å…äº†é™æ€æƒé‡ï¼ˆReward Shapingï¼‰çš„è¿‡ä¼˜åŒ–é—®é¢˜ã€‚